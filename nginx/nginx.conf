worker_processes auto;  # CPU 코어 수 자동 감지

events {
    worker_connections 1024;  # 또는 2048, 4096 등으로 조정 가능
}

http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    sendfile        on;
    keepalive_timeout  65;

    # Nginx 로그를 Docker 표준 출력/에러로 리다이렉션
    access_log /dev/stdout;  # access log를 표준 출력으로
    error_log /dev/stderr warn;  # error log를 표준 에러로, warning 레벨 이상만 기록

    # Gzip 압축 설정
    gzip on;
    gzip_proxied any;  # 프록시된 요청에도 gzip 압축 적용
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;  # 압축할 MIME 타입 지정 (svg도 포함)
    gzip_comp_level 6;  # 압축 레벨 (1-9, 6이 일반적으로 적절)
    gzip_vary on;  # vary: Accept-Encoding 헤더 추가 (캐시 문제 방지)

    # 보안 헤더 (http 블록에 추가하여 모든 server 블록에 공통 적용)
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains";  # HSTS 활성화 (웹 브라우저에게 항상 HTTPS 사용 강제)
    add_header X-Frame-Options "DENY";  # Clickjacking 방지
    add_header X-Content-Type-Options "nosniff";  # MIME-Type 스니핑 방지
    add_header X-XSS-Protection "1; mode=block";  # XSS 공격 방지

    # HTTP (80 포트) 요청을 HTTPS (443 포트)로 리다이렉트
    server {
        listen 80;
        server_name www.jaehoon.link jenkins.jaehoon.link;  # 모든 도메인을 포함
        return 301 https://$host$request_uri;  # HTTPS로 강제 리다이렉트
    }

    # 메인 웹 서비스 (www.jaehoon.link) HTTPS 설정
    server {
        listen 443 ssl;  # http2 옵션 제거
        http2 on;  # 별도의 지시자로 추가
        server_name www.jaehoon.link;  # 실제 도메인으로 변경

        # SSL 인증서 경로 설정 (컨테이너 내부 경로)
        ssl_certificate /etc/nginx/ssl/www.jaehoon.link/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/www.jaehoon.link/privkey.pem;

        # SSL 최적화 및 보안 설정 (권장)
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_stapling on;
        ssl_stapling_verify on;
        #resolver 8.8.8.8 8.8.4.4 valid=300s;  # 외부(Google) DNS 대신 Docker 내부 DNS를 활용
        resolver 127.0.0.11 valid=30s;  # Docker 내부 DNS 서버 주소 (기본값)
        resolver_timeout 5s;

        location / {
            proxy_pass http://web:8080;  # web 컨테이너로 프록시
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # 프록시 버퍼링 설정 추가
            proxy_buffering on;  # 버퍼링 활성화
            proxy_buffer_size 128k;  # 버퍼 크기
            proxy_buffers 4 256k;  # 4개의 256KB 버퍼
            proxy_busy_buffers_size 256k;  # busy 버퍼 크기
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }

    # Jenkins 서비스 (jenkins.jaehoon.link) HTTPS 설정
    server {
        listen 443 ssl;  # http2 옵션 제거
        http2 on;  # 별도의 지시자로 추가
        server_name jenkins.jaehoon.link;  # Jenkins 서브 도메인

        # SSL 인증서 경로 설정 (컨테이너 내부 경로)
        ssl_certificate /etc/nginx/ssl/jenkins.jaehoon.link/fullchain.pem;
        ssl_certificate_key /etc/nginx/ssl/jenkins.jaehoon.link/privkey.pem;

        # SSL 최적화 및 보안 설정 (권장)
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
        ssl_prefer_server_ciphers on;
        ssl_session_cache shared:SSL:10m;
        ssl_session_timeout 10m;
        ssl_stapling on;
        ssl_stapling_verify on;
        #resolver 8.8.8.8 8.8.4.4 valid=300s;  # 외부(Google) DNS 대신 Docker 내부 DNS를 활용
        resolver 127.0.0.11 valid=30s;  # Docker 내부 DNS 서버 주소 (기본값)
        resolver_timeout 5s;

        location / {
            proxy_pass http://jenkins:8080;  # jenkins 컨테이너로 프록시
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            # Jenkins 관련 프록시 설정
            proxy_read_timeout 900;  # Jenkins 빌드 시간 고려
            proxy_connect_timeout 900;
            proxy_send_timeout 900;

            proxy_redirect http://jenkins:8080 https://$host/;  # Jenkins가 생성하는 내부 URL을 외부 URL로 변경 (리다이렉트 처리)
            proxy_http_version 1.1;  # HTTP/1.1 사용
            proxy_set_header Upgrade $http_upgrade;  # 웹소켓 업그레이드 지원
            proxy_set_header Connection "upgrade";  # 웹소켓 업그레이드 지원

            # 프록시 버퍼링 설정 추가
            proxy_buffering on;  # 버퍼링 활성화
            proxy_buffer_size 128k;  # 버퍼 크기
            proxy_buffers 4 256k;  # 4개의 256KB 버퍼
            proxy_busy_buffers_size 256k;  # busy 버퍼 크기
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            root /usr/share/nginx/html;
        }
    }
}
